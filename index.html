<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Among Us Voting</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#0b132b;
  color:#fff;
  font-family:Arial,sans-serif;
  text-align:center;
}
.hidden{display:none}
button,input{
  padding:12px;
  margin:6px;
  width:90%;
  max-width:280px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:10px;
  padding:10px;
}
.card{
  background:#1c2541;
  border-radius:14px;
  padding:10px;
  position:relative;
}
.dead{opacity:0.35}
.timer{color:#ffd166;font-size:20px;margin:10px}

.vote-card{
  cursor:pointer;
  border:2px solid transparent;
}
.vote-card.selected{
  border-color:#4caf50;
}
.tick{
  position:absolute;
  top:6px;
  right:8px;
  font-size:18px;
  color:#4caf50;
}

.crewmate{
  width:60px;
  margin:auto;
  animation:float 1.6s ease-in-out infinite;
}
@keyframes float{
  0%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
  100%{transform:translateY(0)}
}
.eject{
  animation:eject 1.8s forwards;
}
@keyframes eject{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(120px,-180px) scale(0);opacity:0}
}
</style>
</head>

<body>

<h2>ðŸš¨ Emergency Meeting</h2>

<div id="joinScreen">
  <input id="nameInput" placeholder="Enter name">
  <button onclick="join()">Join</button>
</div>

<div id="lobbyScreen" class="hidden">
  <h3>Lobby</h3>
  <div id="lobbyGrid" class="grid"></div>
  <button id="startBtn" class="hidden" onclick="start()">Start Voting</button>
</div>

<div id="voteScreen" class="hidden">
  <div class="timer" id="timer"></div>
  <div id="voteGrid" class="grid"></div>
  <div id="voteButtons"></div>
</div>

<div id="resultScreen" class="hidden">
  <h3 id="resultText"></h3>
  <div id="resultGrid" class="grid"></div>
  <button onclick="nextRound()">Next Round</button>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBVF5JW7IyGRvKrX7xwOTdEPg4019s3Bn0",
Â  authDomain: "amongus1-test.firebaseapp.com",
Â  databaseURL: "https://amongus1-test-default-rtdb.firebaseio.com",
Â  projectId: "amongus1-test",
Â  storageBucket: "amongus1-test.firebasestorage.app",
Â  messagingSenderId: "345866430610",
Â  appId: "1:345866430610:web:fb4c24d7533496e2751e4b"
});
const db=firebase.database();

// ================= ROOM =================
const roomId=location.hash.slice(1)||Math.random().toString(36).slice(2,7);
location.hash=roomId;
const room=`rooms/${roomId}`;

// ================= STATE =================
let me=null,isHost=false,players={},timerInt=null,selectedVote=null;

// ================= CREWMATE SVG =================
function crewmate(color){
  return `
  <svg class="crewmate" viewBox="0 0 200 300">
    <ellipse cx="100" cy="150" rx="70" ry="90" fill="${color}"/>
    <ellipse cx="130" cy="90" rx="45" ry="30" fill="#bdefff"/>
    <ellipse cx="130" cy="90" rx="35" ry="20" fill="#e8f8ff"/>
  </svg>`;
}

// ================= JOIN =================
function join(){
  const name=nameInput.value.trim();
  if(!name) return alert("Enter name");
  me=name;

  db.ref(`${room}/phase`).once("value",s=>{
    if(s.exists() && s.val()!=="LOBBY"){
      joinScreen.innerHTML="<h3>Room Closed</h3>";
      return;
    }

    db.ref(`${room}/players/${name}`).set({
      alive:true,
      color:`hsl(${Math.random()*360},70%,60%)`
    });
    db.ref(`${room}/players/${name}`).onDisconnect().remove();

    db.ref(`${room}/host`).once("value",h=>{
      if(!h.exists()) db.ref(`${room}/host`).set(name);
    });

    db.ref(`${room}/phase`).set("LOBBY");
    joinScreen.classList.add("hidden");
    lobbyScreen.classList.remove("hidden");
  });
}

// ================= HOST =================
db.ref(`${room}/host`).on("value",s=>{
  isHost=s.val()===me;
  startBtn.classList.toggle("hidden",!isHost);
});

// ================= PLAYERS =================
db.ref(`${room}/players`).on("value",s=>{
  players=s.val()||{};
  renderLobby();
});

function renderLobby(){
  lobbyGrid.innerHTML="";
  Object.entries(players).forEach(([n,p])=>{
    lobbyGrid.innerHTML+=`
      <div class="card ${p.alive?"":"dead"}">
        ${crewmate(p.color)}
        <div>${n}</div>
      </div>`;
  });
}

// ================= START =================
function start(){
  if(!isHost) return;
  db.ref(room).update({
    phase:"VOTE",
    time:15,
    votes:{},
    result:null
  });
  startTimer(15);
}

// ================= TIMER =================
function startTimer(t){
  clearInterval(timerInt);
  db.ref(`${room}/time`).set(t);
  timerInt=setInterval(()=>{
    t--;
    db.ref(`${room}/time`).set(t);
    if(t<=0){
      clearInterval(timerInt);
      finalize();
    }
  },1000);
}

db.ref(`${room}/time`).on("value",s=>{
  if(typeof s.val()==="number")
    timer.innerText=`Time: ${s.val()}`;
});

// ================= PHASE =================
db.ref(`${room}/phase`).on("value",s=>{
  const p=s.val();
  if(!p) return;

  lobbyScreen.classList.add("hidden");
  voteScreen.classList.add("hidden");
  resultScreen.classList.add("hidden");

  if(p==="VOTE"){
    voteScreen.classList.remove("hidden");
    renderVoteCards();
  }
  if(p==="RESULT"){
    resultScreen.classList.remove("hidden");
    showResult();
  }
});

// ================= VOTING =================
function renderVoteCards(){
  voteGrid.innerHTML="";
  voteButtons.innerHTML="";
  selectedVote=null;

  Object.entries(players).forEach(([n,p])=>{
    if(!p.alive||n===me) return;

    const card=document.createElement("div");
    card.className="card vote-card";
    card.onclick=()=>selectVote(n,card);
    card.innerHTML=`
      ${crewmate(p.color)}
      <div>${n}</div>
      <div class="tick hidden">âœ”</div>
    `;
    voteGrid.appendChild(card);
  });

  const skip=document.createElement("div");
  skip.className="card vote-card";
  skip.onclick=()=>selectVote("SKIP",skip);
  skip.innerHTML=`<div>SKIP</div><div class="tick hidden">âœ”</div>`;
  voteGrid.appendChild(skip);
}

function selectVote(target,card){
  document.querySelectorAll(".vote-card").forEach(c=>{
    c.classList.remove("selected");
    c.querySelector(".tick").classList.add("hidden");
  });
  card.classList.add("selected");
  card.querySelector(".tick").classList.remove("hidden");
  selectedVote=target;

  voteButtons.innerHTML=`<button onclick="submitVote()">Confirm Vote</button>`;
}

function submitVote(){
  if(!selectedVote) return;
  db.ref(`${room}/votes/${me}`).set(selectedVote);
  voteButtons.innerHTML="<p>VOTED</p>";
}

// ================= RESULT CALCULATION =================
function calculateWinner(votes){
  const counts={};
  Object.values(votes).forEach(v=>counts[v]=(counts[v]||0)+1);
  const arr=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  if(arr.length===0) return null;
  const [top,tcount]=arr[0];
  const second=arr[1]?.[1]??0;
  if(tcount===second||top==="SKIP") return null;
  return top;
}

function finalize(){
  if(!isHost) return;

  db.ref(`${room}/votes`).once("value",s=>{
    const votes=s.val()||{};
    const winner=calculateWinner(votes);

    if(winner) players[winner].alive=false;

    db.ref(room).update({
      players,
      result:{winner},
      phase:"RESULT"
    });
  });
}

// ================= SHOW RESULT =================
function showResult(){
  resultGrid.innerHTML="";
  resultText.innerText="Loading...";

  Promise.all([
    db.ref(`${room}/players`).once("value"),
    db.ref(`${room}/result`).once("value")
  ]).then(([pSnap,rSnap])=>{
    const freshPlayers=pSnap.val()||{};
    const winner=rSnap.val()?.winner||null;

    Object.entries(freshPlayers).forEach(([n,p])=>{
      resultGrid.innerHTML+=`
        <div class="card ${n===winner?"eject":""} ${!p.alive?"dead":""}">
          ${crewmate(p.color)}
          <div>${n}</div>
        </div>`;
    });

    resultText.innerText=winner
      ? `${winner} was ejected`
      : "No one was ejected (Skip / Tie)";
  });
}

// ================= NEXT ROUND =================
function nextRound(){
  if(!isHost) return;
  db.ref(room).remove().then(()=>location.reload());
}
</script>

</body>
</html>
