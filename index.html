<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Among Us Voting</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background: #0b132b;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}

.hidden { display: none; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
  gap: 10px;
  padding: 10px;
}

.card {
  background: #1c2541;
  border-radius: 12px;
  padding: 8px;
  position: relative;
}

.vote-card {
  cursor: pointer;
  border: 2px solid transparent;
}
.vote-card.selected {
  border-color: #4caf50;
}

.crewmate {
  width: 50px;
  margin: auto;
  animation: float 1.5s ease-in-out infinite;
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
  100% { transform: translateY(0); }
}

.vote-icons {
  font-size: 10px;
  margin-top: 4px;
}

.timer {
  font-size: 18px;
  color: #ffd166;
}

.eject {
  animation: eject 2s forwards;
}
@keyframes eject {
  to {
    transform: translate(120px, -200px) scale(0);
    opacity: 0;
  }
}
</style>
</head>

<body>

<h2>ðŸš¨ Emergency Meeting</h2>

<div id="joinScreen">
  <input id="nameInput" placeholder="Enter name" />
  <button onclick="join()">Join</button>
</div>

<div id="mainScreen" class="hidden">
  <div class="timer" id="timer"></div>
  <div id="grid" class="grid"></div>
  <div id="action"></div>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBVF5JW7IyGRvKrX7xwOTdEPg4019s3Bn0",
Â  authDomain: "amongus1-test.firebaseapp.com",
Â  databaseURL: "https://amongus1-test-default-rtdb.firebaseio.com",
Â  projectId: "amongus1-test",
Â  storageBucket: "amongus1-test.firebasestorage.app",
Â  messagingSenderId: "345866430610",
Â  appId: "1:345866430610:web:fb4c24d7533496e2751e4b"
});
const db = firebase.database();

// ================= ROOM =================
const roomId = location.hash.slice(1) || Math.random().toString(36).slice(2,7);
location.hash = roomId;
const room = `rooms/${roomId}`;

let me = null;
let isHost = false;
let players = {};
let phase = "LOBBY";
let timerInt = null;

// ================= CREWMATE =================
function crewmate(color) {
  return `
    <svg class="crewmate" viewBox="0 0 200 300">
      <ellipse cx="100" cy="150" rx="70" ry="90" fill="${color}" />
      <ellipse cx="130" cy="90" rx="40" ry="25" fill="#ccefff" />
    </svg>`;
}

// ================= JOIN =================
function join() {
  const name = nameInput.value.trim();
  if (!name) return;

  me = name;

  db.ref(`${room}/players/${name}`).set({
    color: `hsl(${Math.random()*360},70%,60%)`
  });
  db.ref(`${room}/players/${name}`).onDisconnect().remove();

  db.ref(`${room}/host`).once("value", s => {
    if (!s.exists()) db.ref(`${room}/host`).set(name);
  });

  db.ref(`${room}/phase`).set("DISCUSS");

  joinScreen.classList.add("hidden");
  mainScreen.classList.remove("hidden");
}

// ================= LISTENERS =================
db.ref(`${room}/players`).on("value", s => {
  players = s.val() || {};
  render();
});

db.ref(`${room}/host`).on("value", s => {
  isHost = s.val() === me;
});

db.ref(`${room}/phase`).on("value", s => {
  phase = s.val();
  render();
});

db.ref(`${room}/time`).on("value", s => {
  if (typeof s.val() === "number")
    timer.innerText = `Time: ${s.val()}`;
});

// ================= RENDER =================
function render() {
  grid.innerHTML = "";
  action.innerHTML = "";

  Object.entries(players).forEach(([name,p]) => {
    const card = document.createElement("div");
    card.className = "card vote-card";
    card.innerHTML = `
      ${crewmate(p.color)}
      <div>${name}</div>
      <div class="vote-icons" id="votes-${name}"></div>
    `;

    if (phase === "VOTE") {
      card.onclick = () => vote(name, card);
    }

    grid.appendChild(card);
  });

  // SKIP CARD
  if (phase === "VOTE" || phase === "REVEAL") {
    const skip = document.createElement("div");
    skip.className = "card vote-card";
    skip.innerHTML = `<div>SKIP</div><div id="votes-SKIP"></div>`;
    if (phase === "VOTE") skip.onclick = () => vote("SKIP", skip);
    grid.appendChild(skip);
  }

  if (phase === "DISCUSS" && isHost) {
    action.innerHTML = `<button onclick="startVote()">Start Voting</button>`;
  }
}

// ================= DISCUSS â†’ VOTE =================
function startVote() {
  startTimer(15, "VOTE");
}

// ================= TIMER =================
function startTimer(seconds, nextPhase) {
  clearInterval(timerInt);
  db.ref(`${room}/time`).set(seconds);
  db.ref(`${room}/phase`).set(nextPhase);

  timerInt = setInterval(() => {
    seconds--;
    db.ref(`${room}/time`).set(seconds);
    if (seconds <= 0) {
      clearInterval(timerInt);
      if (nextPhase === "VOTE") revealVotes();
    }
  }, 1000);
}

// ================= VOTING =================
function vote(target, card) {
  db.ref(`${room}/votes/${me}`).set(target);
  document.querySelectorAll(".vote-card").forEach(c => c.classList.remove("selected"));
  card.classList.add("selected");
}

// ================= REVEAL =================
function revealVotes() {
  db.ref(`${room}/phase`).set("REVEAL");

  db.ref(`${room}/votes`).once("value", snap => {
    const votes = snap.val() || {};
    Object.entries(votes).forEach(([voter,target]) => {
      const el = document.getElementById(`votes-${target}`);
      if (el) el.innerText += "ðŸ§‘";
    });

    setTimeout(eject, 7000);
  });
}

// ================= EJECTION =================
function eject() {
  db.ref(`${room}/phase`).set("EJECT");

  db.ref(`${room}/votes`).once("value", snap => {
    const votes = snap.val() || {};
    const counts = {};
    Object.values(votes).forEach(v => counts[v] = (counts[v]||0)+1);

    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const winner =
      sorted.length > 1 && sorted[0][1] === sorted[1][1] ? null :
      sorted[0]?.[0] === "SKIP" ? null :
      sorted[0]?.[0];

    if (winner) {
      document.querySelectorAll(".card").forEach(c=>{
        if (c.innerText.includes(winner)) c.classList.add("eject");
      });
    }
  });
}
</script>
</body>
</html>
