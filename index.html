<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Among Us Voting</title>

<!-- FORCE HARD REFRESH -->
<script>
(function(){
  const u=new URL(location.href);
  if(!u.searchParams.has("nocache")){
    u.searchParams.set("nocache",Date.now());
    location.replace(u.pathname+"?"+u.searchParams+location.hash);
  }
})();
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#0b132b;color:#fff;font-family:Arial;text-align:center}
.hidden{display:none}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:10px;padding:10px
}
.card{
  background:#1c2541;
  border-radius:12px;
  padding:8px;
  position:relative;
}
.vote-card{cursor:pointer;border:2px solid transparent}
.vote-card.selected{border-color:#4caf50}

.crewmate{width:50px;margin:auto}
.mini{width:16px;display:inline-block;margin:2px}
.vote-icons{margin-top:4px}

.timer{font-size:18px;color:#ffd166}

button,input{
  padding:12px;width:90%;max-width:280px;margin:6px
}

/* LAVA FALL */
.lava{
  position:absolute;
  bottom:-40px;
  width:100%;
  height:30px;
  background:linear-gradient(#ff4500,#b30000);
  border-radius:0 0 12px 12px;
}
.fall{
  animation:fall 2.5s forwards ease-in;
}
@keyframes fall{
  0%{transform:translateY(0)}
  70%{transform:translateY(120px)}
  100%{transform:translateY(220px) scale(0);opacity:0}
}

@media(max-width:600px){
  .grid{grid-template-columns:repeat(auto-fit,minmax(80px,1fr))}
}
</style>
</head>

<body>

<h2>ðŸš¨ Emergency Meeting</h2>

<div id="joinScreen">
  <input id="nameInput" placeholder="Enter name">
  <button onclick="join()">Join</button>
</div>

<div id="mainScreen" class="hidden">
  <div id="timer" class="timer"></div>
  <div id="grid" class="grid"></div>
  <div id="action"></div>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBVF5JW7IyGRvKrX7xwOTdEPg4019s3Bn0",
Â  authDomain: "amongus1-test.firebaseapp.com",
Â  databaseURL: "https://amongus1-test-default-rtdb.firebaseio.com",
Â  projectId: "amongus1-test",
Â  storageBucket: "amongus1-test.firebasestorage.app",
Â  messagingSenderId: "345866430610",
Â  appId: "1:345866430610:web:fb4c24d7533496e2751e4b"
});
const db=firebase.database();

// ================= CONSTANTS =================
const COLORS=["#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6","#e67e22","#1abc9c","#ecf0f1","#7f8c8d","#e84393"];

// ================= ROOM =================
const roomId=location.hash.slice(1)||Math.random().toString(36).slice(2,7);
location.hash=roomId;
const room=`rooms/${roomId}`;

let me=null,isHost=false,players={},phase="DISCUSS";
let selectedVote=null,timerInt=null;

// ================= CREWMATE =================
function crewmate(color,cls="crewmate"){
  return `
  <svg class="${cls}" viewBox="0 0 200 300">
    <ellipse cx="100" cy="150" rx="70" ry="90" fill="${color}"/>
    <ellipse cx="130" cy="90" rx="40" ry="25" fill="#ccefff"/>
  </svg>`;
}

// ================= JOIN =================
function join(){
  const name=nameInput.value.trim();
  if(!name)return;
  me=name;

  db.ref(`${room}/players`).once("value",snap=>{
    const used=Object.values(snap.val()||{}).map(p=>p.color);
    const color=COLORS.find(c=>!used.includes(c));

    db.ref(`${room}/players/${name}`).set({color});
    db.ref(`${room}/players/${name}`).onDisconnect().remove();

    db.ref(`${room}/host`).once("value",h=>{
      if(!h.exists())db.ref(`${room}/host`).set(name);
    });

    db.ref(`${room}/phase`).set("DISCUSS");

    joinScreen.classList.add("hidden");
    mainScreen.classList.remove("hidden");
  });
}

// ================= LISTENERS =================
db.ref(`${room}/players`).on("value",s=>{players=s.val()||{};render()});
db.ref(`${room}/host`).on("value",s=>isHost=s.val()===me);
db.ref(`${room}/phase`).on("value",s=>{phase=s.val();render()});
db.ref(`${room}/time`).on("value",s=>{
  if(typeof s.val()==="number")timer.innerText=`Time: ${s.val()}`;
});

// ================= RENDER =================
function render(){
  grid.innerHTML="";
  action.innerHTML="";

  Object.entries(players).forEach(([name,p])=>{
    const card=document.createElement("div");
    card.className="card vote-card";
    card.innerHTML=`
      ${crewmate(p.color)}
      <div>${name}</div>
      <div class="vote-icons" id="votes-${name}"></div>
      <div class="lava"></div>
    `;
    if(phase==="VOTE")card.onclick=()=>selectVote(name,card);
    grid.appendChild(card);
  });

  if(["VOTE","REVEAL"].includes(phase)){
    const skip=document.createElement("div");
    skip.className="card vote-card";
    skip.innerHTML=`<div>SKIP</div><div class="vote-icons" id="votes-SKIP"></div>`;
    if(phase==="VOTE")skip.onclick=()=>selectVote("SKIP",skip);
    grid.appendChild(skip);
  }

  if(phase==="DISCUSS"&&isHost){
    action.innerHTML=`<button onclick="startVote()">Start Voting</button>`;
  }
  if(phase==="VOTE"){
    action.innerHTML=`<button onclick="confirmVote()">Confirm Vote</button>`;
  }
  if(phase==="REVEAL"){
    renderVoteReveal();
  }
  if(phase==="END"){
    action.innerHTML=`<button onclick="nextRound()">Next Round</button>`;
  }
}

// ================= VOTING =================
function selectVote(target,card){
  selectedVote=target;
  document.querySelectorAll(".vote-card").forEach(c=>c.classList.remove("selected"));
  card.classList.add("selected");
}
function confirmVote(){
  if(!selectedVote)return;
  db.ref(`${room}/votes/${me}`).set(selectedVote);
  action.innerHTML="<div>VOTED âœ”</div>";
}

// ================= START VOTE =================
function startVote(){
  startTimer(30,"VOTE");
  watchAutoEnd();
}

// ================= TIMER =================
function startTimer(sec,next){
  clearInterval(timerInt);
  db.ref(`${room}/phase`).set(next);
  db.ref(`${room}/time`).set(sec);
  timerInt=setInterval(()=>{
    sec--;
    db.ref(`${room}/time`).set(sec);
    if(sec<=0){
      clearInterval(timerInt);
      revealVotes();
    }
  },1000);
}

// ================= AUTO END WHEN ALL VOTED =================
function watchAutoEnd(){
  if(!isHost)return;
  db.ref(`${room}/votes`).on("value",snap=>{
    if(phase!=="VOTE")return;
    if(Object.keys(snap.val()||{}).length===Object.keys(players).length){
      clearInterval(timerInt);
      revealVotes();
    }
  });
}

// ================= REVEAL =================
function revealVotes(){
  db.ref(`${room}/phase`).set("REVEAL");
  setTimeout(eject,12000); // 10â€“15 seconds
}

// ================= RENDER REVEAL =================
function renderVoteReveal(){
  db.ref(`${room}/votes`).once("value",snap=>{
    const votes=snap.val()||{};
    Object.entries(votes).forEach(([voter,target])=>{
      const el=document.getElementById(`votes-${target}`);
      if(el)el.innerHTML+=crewmate(players[voter].color,"mini");
    });
  });
}

// ================= EJECT =================
function eject(){
  db.ref(`${room}/phase`).set("EJECT");
  db.ref(`${room}/votes`).once("value",snap=>{
    const counts={};
    Object.values(snap.val()||{}).forEach(v=>counts[v]=(counts[v]||0)+1);
    const arr=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const winner=
      arr.length>1&&arr[0][1]===arr[1][1]?null:
      arr[0]?.[0]==="SKIP"?null:
      arr[0]?.[0];

    if(winner){
      [...grid.children].forEach(c=>{
        if(c.innerText.includes(winner)){
          c.classList.add("fall");
        }
      });
    }
    setTimeout(()=>db.ref(`${room}/phase`).set("END"),3000);
  });
}

// ================= NEXT ROUND =================
function nextRound(){
  db.ref(`${room}/ready/${me}`).set(true);
  if(isHost){
    db.ref(`${room}/ready`).on("value",snap=>{
      if(Object.keys(snap.val()||{}).length===Object.keys(players).length){
        db.ref(room).remove().then(()=>location.reload());
      }
    });
  }
}
</script>
</body>
</html>
