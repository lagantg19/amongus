<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Among Us Voting</title>

<!-- FORCE HARD REFRESH -->
<script>
(function(){
  const u=new URL(location.href);
  if(!u.searchParams.has("nocache")){
    u.searchParams.set("nocache",Date.now());
    location.replace(u.pathname+"?"+u.searchParams+location.hash);
  }
})();
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial;
  text-align:center;
}
.hidden{display:none}

/* ---------- GENERAL ---------- */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:10px;
  padding:10px;
}
.card{
  background:#1c2541;
  border-radius:12px;
  padding:8px;
}
.vote-card{cursor:pointer;border:2px solid transparent}
.vote-card.selected{border-color:#4caf50}

.crewmate{width:50px;margin:auto}
.mini{width:16px;margin:2px}
.vote-icons{margin-top:4px}
.timer{font-size:18px;color:#ffd166}

button,input{
  padding:12px;
  width:90%;
  max-width:280px;
  margin:6px;
}

/* ---------- CINEMATIC ---------- */
#cinematic{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

#cinematic .crew{
  width:120px;
  animation:drop 4s forwards ease-in;
}

#lava{
  position:absolute;
  bottom:0;
  width:100%;
  height:120px;
  background:linear-gradient(#ff6a00,#b30000);
  animation:bubble 1.2s infinite alternate;
}

@keyframes drop{
  0%{transform:translateY(-200px)}
  60%{transform:translateY(0)}
  100%{transform:translateY(400px) scale(0.2);opacity:0}
}

@keyframes bubble{
  from{filter:brightness(1)}
  to{filter:brightness(1.4)}
}

@media(max-width:600px){
  .grid{grid-template-columns:repeat(auto-fit,minmax(80px,1fr))}
}
</style>
</head>

<body>

<h2 id="title">ðŸš¨ Emergency Meeting</h2>

<div id="joinScreen">
  <input id="nameInput" placeholder="Enter name">
  <button onclick="join()">Join</button>
</div>

<div id="mainScreen" class="hidden">
  <div id="timer" class="timer"></div>
  <div id="grid" class="grid"></div>
  <div id="action"></div>
</div>

<div id="cinematic" class="hidden"></div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBVF5JW7IyGRvKrX7xwOTdEPg4019s3Bn0",
Â  authDomain: "amongus1-test.firebaseapp.com",
Â  databaseURL: "https://amongus1-test-default-rtdb.firebaseio.com",
Â  projectId: "amongus1-test",
Â  storageBucket: "amongus1-test.firebasestorage.app",
Â  messagingSenderId: "345866430610",
Â  appId: "1:345866430610:web:fb4c24d7533496e2751e4b"
});
const db=firebase.database();

// ================= CONSTANTS =================
const COLORS=[
  "#e74c3c","#3498db","#2ecc71","#f1c40f",
  "#9b59b6","#e67e22","#1abc9c",
  "#ecf0f1","#7f8c8d","#e84393"
];

// ================= ROOM =================
const roomId=location.hash.slice(1)||Math.random().toString(36).slice(2,7);
location.hash=roomId;
const room=`rooms/${roomId}`;

let me=null,isHost=false,players={},phase="DISCUSS";
let selectedVote=null,timerInt=null;

// ================= CREWMATE SVG =================
function crewmate(color,cls="crewmate"){
  return `
  <svg class="${cls}" viewBox="0 0 200 300">
    <ellipse cx="100" cy="150" rx="70" ry="90" fill="${color}"/>
    <ellipse cx="130" cy="90" rx="40" ry="25" fill="#ccefff"/>
  </svg>`;
}

// ================= JOIN =================
function join(){
  const name=nameInput.value.trim();
  if(!name)return;
  me=name;

  db.ref(`${room}/players`).once("value",snap=>{
    const used=Object.values(snap.val()||{}).map(p=>p.color);
    const color=COLORS.find(c=>!used.includes(c));

    db.ref(`${room}/players/${name}`).set({color});
    db.ref(`${room}/players/${name}`).onDisconnect().remove();

    db.ref(`${room}/host`).once("value",h=>{
      if(!h.exists())db.ref(`${room}/host`).set(name);
    });

    db.ref(`${room}/phase`).set("DISCUSS");
    joinScreen.classList.add("hidden");
    mainScreen.classList.remove("hidden");
  });
}

// ================= LISTENERS =================
db.ref(`${room}/players`).on("value",s=>players=s.val()||{});
db.ref(`${room}/host`).on("value",s=>isHost=s.val()===me);
db.ref(`${room}/phase`).on("value",s=>{phase=s.val();render()});
db.ref(`${room}/time`).on("value",s=>{
  if(typeof s.val()==="number")timer.innerText=`Time: ${s.val()}`;
});

// ================= RENDER =================
function render(){
  grid.innerHTML="";
  action.innerHTML="";
  cinematic.classList.add("hidden");
  mainScreen.classList.remove("hidden");

  if(phase==="EJECT_CINEMATIC"){
    playCinematic();
    return;
  }

  Object.entries(players).forEach(([name,p])=>{
    const card=document.createElement("div");
    card.className="card vote-card";
    card.innerHTML=`
      ${crewmate(p.color)}
      <div>${name}</div>
      <div class="vote-icons" id="votes-${name}"></div>
    `;
    if(phase==="VOTE")card.onclick=()=>selectVote(name,card);
    grid.appendChild(card);
  });

  if(["VOTE","REVEAL"].includes(phase)){
    const skip=document.createElement("div");
    skip.className="card vote-card";
    skip.innerHTML=`<div>SKIP</div><div class="vote-icons" id="votes-SKIP"></div>`;
    if(phase==="VOTE")skip.onclick=()=>selectVote("SKIP",skip);
    grid.appendChild(skip);
  }

  if(phase==="DISCUSS"&&isHost){
    action.innerHTML=`<button onclick="startVote()">Start Voting</button>`;
  }
  if(phase==="VOTE"){
    action.innerHTML=`<button onclick="confirmVote()">Confirm Vote</button>`;
  }
  if(phase==="REVEAL"){
    renderVoteReveal();
  }
  if(phase==="END"){
    action.innerHTML=`<button onclick="nextRound()">Next Round</button>`;
  }
}

// ================= VOTING =================
function selectVote(target,card){
  selectedVote=target;
  document.querySelectorAll(".vote-card").forEach(c=>c.classList.remove("selected"));
  card.classList.add("selected");
}
function confirmVote(){
  if(!selectedVote)return;
  db.ref(`${room}/votes/${me}`).set(selectedVote);
  action.innerHTML="<div>VOTED âœ”</div>";
}

// ================= START VOTE =================
function startVote(){
  startTimer(30,"VOTE");
  watchAutoEnd();
}

// ================= TIMER =================
function startTimer(sec,next){
  clearInterval(timerInt);
  db.ref(`${room}/phase`).set(next);
  db.ref(`${room}/time`).set(sec);
  timerInt=setInterval(()=>{
    sec--;
    db.ref(`${room}/time`).set(sec);
    if(sec<=0){
      clearInterval(timerInt);
      revealVotes();
    }
  },1000);
}

// ================= AUTO END =================
function watchAutoEnd(){
  if(!isHost)return;
  db.ref(`${room}/votes`).on("value",snap=>{
    if(phase!=="VOTE")return;
    if(Object.keys(snap.val()||{}).length===Object.keys(players).length){
      clearInterval(timerInt);
      revealVotes();
    }
  });
}

// ================= REVEAL =================
function revealVotes(){
  db.ref(`${room}/phase`).set("REVEAL");
  setTimeout(()=>db.ref(`${room}/phase`).set("EJECT_CINEMATIC"),12000);
}

// ================= RENDER REVEAL =================
function renderVoteReveal(){
  db.ref(`${room}/votes`).once("value",snap=>{
    const votes=snap.val()||{};
    Object.entries(votes).forEach(([voter,target])=>{
      const el=document.getElementById(`votes-${target}`);
      if(el){
        el.innerHTML+=crewmate(players[voter].color,"mini");
      }
    });
  });
}

// ================= CINEMATIC =================
function playCinematic(){
  mainScreen.classList.add("hidden");
  cinematic.classList.remove("hidden");
  cinematic.innerHTML="";

  db.ref(`${room}/votes`).once("value",snap=>{
    const counts={};
    Object.values(snap.val()||{}).forEach(v=>counts[v]=(counts[v]||0)+1);
    const arr=Object.entries(counts).sort((a,b)=>b[1]-a[1]);

    const winner=
      arr.length>1&&arr[0][1]===arr[1][1]?null:
      arr[0]?.[0]==="SKIP"?null:
      arr[0]?.[0];

    if(!winner){
      cinematic.innerHTML="<h2>No one was ejected</h2>";
      setTimeout(()=>db.ref(`${room}/phase`).set("END"),4000);
      return;
    }

    const color=players[winner].color;

    cinematic.innerHTML=`
      <div class="crew">${crewmate(color,"crew")}</div>
      <div id="lava"></div>
    `;

    setTimeout(()=>db.ref(`${room}/phase`).set("END"),4500);
  });
}

// ================= NEXT ROUND =================
function nextRound(){
  db.ref(`${room}/ready/${me}`).set(true);
  if(isHost){
    db.ref(`${room}/ready`).on("value",snap=>{
      if(Object.keys(snap.val()||{}).length===Object.keys(players).length){
        db.ref(room).remove().then(()=>location.reload());
      }
    });
  }
}
</script>

</body>
</html>
